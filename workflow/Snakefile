#Pipeline for DRM calling
#Here we will read config file which contains information about which tools to use
#for alignment and variant calling, and write rules to decide will rules in the rules folder to call.

# Parse Bowtie2 parameters.
#TODO Error checks
aligner_params = None
aligner_params_group_names = None
aligner_params_header = None
aligner_params_dict = None

if config['aligner'] == 'bowtie2':
    aligner_params = config["bowtie2_params"]
    aligner_params_group_names = aligner_params[1:]
    aligner_params_header = aligner_params[0]
    aligner_params_dict = {}
    for param_list in aligner_params[1:]:
        group_name = param_list[0]
        aligner_params_dict[group_name] = dict(zip(aligner_params_header,param_list))
    
else:
    aligner_params = config["last_params"]
    aligner_params_group_names = aligner_params[1:]
    aligner_params_header = aligner_params[0]
    aligner_params_dict = {}
    for param_list in aligner_params[1:]:
        group_name = param_list[0]
        aligner_params_dict[group_name] = dict(zip(aligner_params_header,param_list))

config['aligner_params_dict'] = aligner_params_dict

lofreq_params = config["lofreq_params"]
lofreq_params_group_names = lofreq_params[0][1:]
lofreq_params_header = lofreq_params[0]
lofreq_params_dict = {}

for param_list in lofreq_params[1:]:
    group_name = param_list[0]
    lofreq_params_dict[group_name] = dict(zip(lofreq_params_header[1:], param_list[1:]))

config['lofreq_params_dict'] = lofreq_params_dict


include: "rules/count_alns.smk"
include: "rules/filter_reads.smk"
include: "rules/bowtie2.smk"
include: "rules/last.smk"
include: "rules/bam.smk"
include: "rules/lofreq.smk"
include: "rules/hivdb_query.smk"
include: "rules/blast.smk"
# include: "rules/map_to_hxb2.smk"
include: "rules/gatk.smk"
include: "rules/bcftools.smk"

# Rule to generate drug resistance report
rule all:
     input:
         expand("{out_dir}/drug_resistance_report/{country}/{sample_id}_to_{reference_name}/paramgroup_{param_group}/results_{aligner}.txt",
                out_dir = config['out_dir'],
                reference_name = config['reference_name'],
                sample_id =  config['reads'].keys(),
                aligner = config['aligner'],
                country = config['country'],
                param_group = config['aligner_params_dict'].keys(),
            )

# LAST TRAINED Rule to generate drug resistance report
# rule all:
#      input:
#          expand("{out_dir}/drug_resistance_report_filtered/{country}/{sample_id}_to_{reference_name}/paramgroup_{param_group}/results_{aligner}_{lofreq_param_group}.txt",
#                 out_dir = config['out_dir'],
#                 reference_name = config['reference_name'],
#                 sample_id =  config['reads'].keys(),
#                 aligner = config['aligner'],
#                 country = config['country'],
#                 param_group = config['last_params_dict'].keys(),
#                 # param_group = config['{}_params_dict'.format(config['aligner'])].keys(),
#                 lofreq_param_group = config['lofreq_params_dict'].keys()
#             )


# rule all:               
    # input:
    #     expand("{out_dir}/alignment_analysis/to_{reference_name}/plot_alns_{country}.tsv",
    #             out_dir = config['out_dir'],
    #             reference_name = config['reference_name'],
    #             sample_id =  config['reads'].keys(),
    #             aligner = config['aligner'],
    #             country = config['country'],
    #             param_group = config['{}_params_dict'.format(config['aligner'])].keys()
    #         )
    
# rule all:  
#     input:
#         expand("{out_dir}/alignment_analysis/to_{reference_name}/alignments_plot_{country}.pdf",
#                 out_dir = config['out_dir'],
#                 reference_name = config['reference_name'],
#                 sample_id =  config['reads'].keys(),
#                 aligner = config['aligner'],
#                 country = config['country'],
#                 param_group = config['last_params_dict'].keys(),
#                 lofreq_param_group = config['lofreq_params_dict'].keys()
#         )